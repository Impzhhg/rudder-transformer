bindings:
  - name: handleRtTfSingleEventError
    path: ../../../../v0/util/index
  - path: ./utils
steps:
  - name: validateInput
    template: |
      $.assert(Array.isArray(^) && ^.length > 0, "Invalid event array")

  - name: transform
    externalWorkflow:
      path: ./procWorkflow.yaml
    loopOverInput: true

  - name: webhookMethod
    template: |
      ^[0].destination.Config.webhookMethod ?? 'POST'

  - name: successfulEvents
    template: |
      $.outputs.transform#idx.output.({
        "batchedRequest": .,
        "batched": false,
        "destination": ^[idx].destination,
        "metadata": ^[idx].metadata[],
        "statusCode": 200
      })[]
  - name: failedEvents
    template: |
      $.outputs.transform#idx.error.(
        $.handleRtTfSingleEventError(^[idx], .originalError ?? ., {})
      )[]
  - name: enableBatching
    template: |
      ^[0].destination.Config.enableBatching ?? false

  - name: batchSuccessfulEvents
    condition: $.outputs.webhookMethod in ['POST', 'PUT', 'PATCH']
    description: Batches the successfulEvents
    template: |
      $.batchResponseBuilder($.outputs.successfulEvents);
  - name: finalPayload
    template: |
      [...$.outputs.failedEvents, ...$.outputs.batchSuccessfulEvents]
